using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Opc.Ua;
using Opc.Ua.Client;

namespace UAClient.Client
{
    public abstract class BaseRemoteCallable : IDataChangeHandler
    {
        public string Name { get; }
        public NodeId BaseNodeId { get; }
        protected UaClient RemoteServerClient { get; }
        protected IDictionary<string, RemoteVariable> FinalResultData = new Dictionary<string, RemoteVariable>();
        protected IDictionary<NodeId, RemoteVariable> _final_result_nodes = new Dictionary<NodeId, RemoteVariable>();
        protected IDictionary<NodeId, RemoteVariable> _monitoring_nodes = new Dictionary<NodeId, RemoteVariable>();
        protected List<Action<RemoteVariable>> _subscribers = new List<Action<RemoteVariable>>();

        protected BaseRemoteCallable(string name, NodeId baseNodeId, UaClient client)
        {
            Name = name;
            BaseNodeId = baseNodeId;
            RemoteServerClient = client;
        }

        public virtual async Task SetupSubscriptionsAsync(SubscriptionManager subscriptionManager, bool createSubscriptions = false)
        {
            // Try to find FinalResultData child and collect variables
            var session = RemoteServerClient.Session ?? throw new InvalidOperationException("No session");
            var browser = new Browser(session)
            {
                BrowseDirection = BrowseDirection.Forward,
                ReferenceTypeId = ReferenceTypeIds.HierarchicalReferences,
                NodeClassMask = (int)(NodeClass.Object | NodeClass.Variable | NodeClass.Method)
            };
            ReferenceDescriptionCollection refs = await browser.BrowseAsync(BaseNodeId);
            if (refs == null) return;
            foreach (var r in refs)
            {
                if (r.DisplayName.Text == "FinalResultData")
                {
                    var expanded = r.NodeId as ExpandedNodeId ?? new ExpandedNodeId(r.NodeId);
                    var childId = UaHelpers.ToNodeId(expanded, session);
                    var nodeMap = new Dictionary<NodeId, RemoteVariable>();
                    await RemoteVariableCollector.AddVariableNodesAsync(session, childId, nodeMap, FinalResultData, false);
                    foreach (var kv in nodeMap)
                    {
                        _final_result_nodes[kv.Key] = kv.Value;
                    }
                    if (_final_result_nodes.Count > 0 && createSubscriptions)
                    {
                        await subscriptionManager.SubscribeDataChangeAsync(this, _final_result_nodes.Keys);
                    }
                }
                if (r.DisplayName.Text == "Monitoring")
                {
                    var expanded = r.NodeId as ExpandedNodeId ?? new ExpandedNodeId(r.NodeId);
                    var childId = UaHelpers.ToNodeId(expanded, session);
                    var nodeMap = new Dictionary<NodeId, RemoteVariable>();
                    await RemoteVariableCollector.AddVariableNodesAsync(session, childId, nodeMap, new System.Collections.Generic.Dictionary<string, RemoteVariable>(), false);
                    foreach (var kv in nodeMap)
                    {
                        _monitoring_nodes[kv.Key] = kv.Value;
                    }
                    if (_monitoring_nodes.Count > 0 && createSubscriptions)
                    {
                        await subscriptionManager.SubscribeDataChangeAsync(this, _monitoring_nodes.Keys);
                    }
                }
            }

            await Task.CompletedTask;
        }

        public void AddSubscriber(Action<RemoteVariable> callback)
        {
            _subscribers.Add(callback);
        }

        public virtual void DataChangeNotification(NodeId nodeId, DataValue value, MonitoredItemNotificationEventArgs args)
        {
            try
            {
                if (_final_result_nodes.TryGetValue(nodeId, out var rv))
                {
                    rv.UpdateFromDataValue(value);
                    foreach (var cb in _subscribers)
                    {
                        try { cb(rv); } catch { }
                    }
                    return;
                }
                if (_monitoring_nodes.TryGetValue(nodeId, out var mv))
                {
                    mv.UpdateFromDataValue(value);
                    // monitoring subscribers currently not exposed; just update values
                    return;
                }
            }
            catch { }
        }
    }
}
