using System;
using System.Diagnostics;
using System.Threading.Tasks;
using BenchmarkDotNet.Attributes;
using BenchmarkDotNet.Configs;
using BenchmarkDotNet.Jobs;
using BenchmarkDotNet.Running;
using UAClient.Client;
using Microsoft.VSDiagnostics;

namespace UAClient.Benchmarks
{
    [SimpleJob(RuntimeMoniker.Net70)]
    [RPlotExporter, MemoryDiagnoser]
    [CPUUsageDiagnoser]
    public class InitializationBenchmarks
    {
        private string _url = "opc.tcp://localhost:4842";
        private string _username = "orchestrator";
        private string _password = "orchestrator";
        [GlobalSetup]
        public void Setup()
        {
        // nothing to do here; real endpoint must be available when running the benchmark
        }

        [Benchmark(Description = "UAClient.ConnectAsync (full init)")]
        public async Task ConnectAsync_FullInit()
        {
            var client = new UaClient(_url, _username, _password);
            var sw = Stopwatch.StartNew();
            try
            {
                await client.ConnectAsync();
            }
            finally
            {
                sw.Stop();
                try
                {
                    await client.DisconnectAsync();
                }
                catch
                {
                }
            }
        }
    }

    // Optional runner for manual execution (not used by BenchmarkDotNet runner normally)
    public class Program
    {
        public static void Main(string[] args)
        {
            BenchmarkRunner.Run<InitializationBenchmarks>();
        }
    }
}