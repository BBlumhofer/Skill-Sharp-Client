using System;
using Opc.Ua;
using Opc.Ua.Client;

namespace UAClient.Client
{
    public static class UaHelpers
    {
        public static NodeId ToNodeId(ExpandedNodeId expanded, Session session)
        {
            if (expanded == null) return NodeId.Null;
            if (!expanded.IsAbsolute)
            {
                // Prefer mapping by NamespaceUri if provided to get the server's namespace index
                ushort ns = 0;
                try
                {
                    if (!string.IsNullOrEmpty(expanded.NamespaceUri))
                    {
                        int idx = session.NamespaceUris.GetIndex(expanded.NamespaceUri);
                        if (idx >= 0) ns = (ushort)idx;
                        else ns = (ushort)expanded.NamespaceIndex;
                    }
                    else
                    {
                        ns = (ushort)expanded.NamespaceIndex;
                    }
                }
                catch
                {
                    ns = (ushort)expanded.NamespaceIndex;
                }

                // Identifier can be numeric, string, or guid; NodeId has overloads
                if (expanded.IdentifierType == IdType.Numeric && expanded.IdType != null)
                {
                    return new NodeId(Convert.ToUInt32(expanded.Identifier), ns);
                }
                else if (expanded.IdentifierType == IdType.String)
                {
                    return new NodeId((string)expanded.Identifier, ns);
                }
                else if (expanded.IdentifierType == IdType.Guid)
                {
                    return new NodeId((Guid)expanded.Identifier, ns);
                }
                else if (expanded.IdentifierType == IdType.Opaque)
                {
                    return new NodeId(expanded.Identifier as byte[], ns);
                }

                // Fallback
                return new NodeId(expanded.Identifier, ns);
            }
            throw new NotSupportedException("Absolute ExpandedNodeId is not supported by this helper");
        }
    }
}
