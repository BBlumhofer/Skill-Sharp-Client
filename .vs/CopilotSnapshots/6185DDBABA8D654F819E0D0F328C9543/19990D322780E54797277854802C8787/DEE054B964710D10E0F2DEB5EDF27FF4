using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Opc.Ua;
using Opc.Ua.Client;

namespace UAClient.Client
{
    public class RemoteMethod : BaseRemoteCallable
    {
        public RemoteMethod(string name, NodeId baseNodeId, UaClient client) : base(name, baseNodeId, client)
        {
        }

        public async Task<IDictionary<string, object?>> CallAsync(params object[] inputs)
        {
            var session = RemoteServerClient.Session ?? throw new InvalidOperationException("No session");
            // Use Call method with object and method node ids. The Python code uses namespace index + Call method name.
            // Here we assume the method is a child method of BaseNodeId; we will find the method references and call the first.
            var browser = new Browser(session) { BrowseDirection = BrowseDirection.Forward };
            ReferenceDescriptionCollection refs = await browser.BrowseAsync(BaseNodeId);
            if (refs == null || refs.Count == 0) throw new InvalidOperationException("No method found to call");
            var methodRef = refs[0];
            var expanded = methodRef.NodeId as ExpandedNodeId ?? new ExpandedNodeId(methodRef.NodeId);
            var methodId = UaHelpers.ToNodeId(expanded, session);
            // Use the SDK's Task-based CallAsync API
            await session.CallAsync(BaseNodeId, methodId, System.Threading.CancellationToken.None, inputs);
            var outDict = new Dictionary<string, object?>();
            // read final result data after call
            foreach (var kv in FinalResultData)
            {
                // attempt to read node value
                try
                {
                    var val = (await session.ReadValueAsync(kv.Value.NodeId, System.Threading.CancellationToken.None)).Value;
                    outDict[kv.Key] = val;
                }
                catch { outDict[kv.Key] = null; }
            }
            await Task.CompletedTask;
            return outDict;
        }
    }
}
